# Architecture Overview

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         MCP Clients                              │
│  (Claude Desktop, VS Code Copilot, Custom Clients)              │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ HTTP/SSE or STDIO
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│              Loopio MCP Server                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Transport Layer (Auto-Detection)                         │  │
│  │  ┌──────────────┐        ┌──────────────┐                │  │
│  │  │ STDIO Mode   │   OR   │  SSE Mode    │                │  │
│  │  │ (Local Dev)  │        │ (Cloud/HTTP) │                │  │
│  │  └──────────────┘        └──────────────┘                │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  MCP Protocol Layer                                       │  │
│  │  - 26 Tools (Library, Projects, Custom Fields, etc.)     │  │
│  │  - 1 Resource (Library Entries)                          │  │
│  │  - 1 Prompt (Search)                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Loopio API Client                                        │  │
│  │  - OAuth 2.0 Token Management                            │  │
│  │  - Automatic Token Refresh (59 min)                      │  │
│  │  - HTTP Client                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ HTTPS + OAuth Bearer Token
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│              Loopio Public API v2                                │
│              (https://api.loopio.com/data/v2)                    │
└─────────────────────────────────────────────────────────────────┘
```

## Deployment Architecture (AWS)

```
┌─────────────────────────────────────────────────────────────────┐
│                      Internet / Users                            │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ HTTPS
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│         Application Load Balancer (ALB)                          │
│         - Health checks: /health                                 │
│         - Routes: /sse, /message                                 │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ HTTP (internal)
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│              AWS ECS Fargate Cluster                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Task: loopio-mcp-server                                  │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │  Container: loopio-mcp-server                       │ │  │
│  │  │  - Image: ECR/loopio-mcp-server:latest             │ │  │
│  │  │  - Port: 3000                                       │ │  │
│  │  │  - CPU: 256, Memory: 512 MB                        │ │  │
│  │  │  - Env: MCP_TRANSPORT=sse, PORT=3000               │ │  │
│  │  └─────────────────────────────────────────────────────┘ │  │
│  │                                                            │  │
│  │  Secrets (from AWS Secrets Manager):                      │  │
│  │  - LOOPIO_CLIENT_ID                                       │  │
│  │  - LOOPIO_CLIENT_SECRET                                   │  │
│  └───────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ Logs
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│         CloudWatch Logs                                          │
│         - Log Group: /ecs/loopio-mcp-server                      │
│         - Retention: 30 days                                     │
└─────────────────────────────────────────────────────────────────┘
```

## Transport Mode Decision Flow

```
                    ┌─────────────┐
                    │   Start     │
                    └──────┬──────┘
                           │
                           ▼
                ┌──────────────────────┐
                │ Check Environment    │
                │ Variables            │
                └──────┬───────────────┘
                       │
           ┌───────────┴───────────┐
           │                       │
           ▼                       ▼
    ┌─────────────┐        ┌─────────────┐
    │ MCP_TRANSPORT│        │    PORT     │
    │  = "sse"?   │        │  is set?    │
    └─────┬───────┘        └─────┬───────┘
          │ Yes                  │ Yes
          │                      │
          └──────────┬───────────┘
                     │
                     ▼ Yes
              ┌─────────────┐
              │  SSE Mode   │
              │             │
              │ - Express   │
              │ - HTTP:3000 │
              │ - /sse      │
              │ - /message  │
              │ - /health   │
              └─────────────┘
                     │
                     │ No (both)
                     │
                     ▼
              ┌─────────────┐
              │ STDIO Mode  │
              │             │
              │ - stdin     │
              │ - stdout    │
              │ - Local Dev │
              └─────────────┘
```

## Data Flow (SSE Mode)

```
┌──────────────┐        1. GET /sse           ┌──────────────┐
│ MCP Client   │──────────────────────────────▶│ MCP Server   │
│              │◀──────────────────────────────│              │
└──────────────┘   2. SSE Stream Established  └──────────────┘
                        (Connection Open)

┌──────────────┐   3. POST /message (request) ┌──────────────┐
│ MCP Client   │──────────────────────────────▶│ MCP Server   │
└──────────────┘                               └──────┬───────┘
                                                      │
                                                      │ 4. Process
                                                      ▼
                                               ┌──────────────┐
                                               │ Loopio API   │
                                               │ Client       │
                                               └──────┬───────┘
                                                      │
                                                      │ 5. API Call
                                                      ▼
                                               ┌──────────────┐
                                               │ Loopio API   │
                                               └──────┬───────┘
                                                      │
                                                      │ 6. Response
┌──────────────┐   7. SSE Event (response)    ┌──────▼───────┐
│ MCP Client   │◀──────────────────────────────│ MCP Server   │
└──────────────┘                               └──────────────┘
```

## Security Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                       Public Internet                            │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Optional: API Gateway / CloudFront                              │
│  - Rate Limiting                                                 │
│  - DDoS Protection                                              │
│  - Custom Domain                                                │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  VPC Security Groups                                             │
│  - Allow: Port 3000 from ALB                                    │
│  - Allow: Outbound HTTPS to Loopio API                         │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  ECS Task                                                        │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Environment: MCP_TRANSPORT=sse                            │ │
│  │  Secrets: LOOPIO_CLIENT_ID, LOOPIO_CLIENT_SECRET          │ │
│  │  (From AWS Secrets Manager)                               │ │
│  └────────────────────────────────────────────────────────────┘ │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ OAuth 2.0
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Loopio API (HTTPS)                                              │
│  - OAuth Token Refresh: Every 59 minutes                        │
│  - SSL Certificate Validation: Configurable                     │
└─────────────────────────────────────────────────────────────────┘
```

## Scalability Model

```
┌──────────────────────────────────────────────────────────────┐
│  Application Load Balancer                                    │
│  - Distributes traffic across tasks                          │
└────┬────────────────────┬────────────────────┬───────────────┘
     │                    │                    │
     ▼                    ▼                    ▼
┌─────────┐          ┌─────────┐          ┌─────────┐
│ Task 1  │          │ Task 2  │   ...    │ Task N  │
│ (0.25   │          │ (0.25   │          │ (0.25   │
│  vCPU,  │          │  vCPU,  │          │  vCPU,  │
│  512MB) │          │  512MB) │          │  512MB) │
└─────────┘          └─────────┘          └─────────┘

Auto-scaling Rules:
- Scale up: CPU > 70% or Memory > 80%
- Scale down: CPU < 30% for 5 minutes
- Min tasks: 1
- Max tasks: 10
```

## Cost Optimization

```
Development/Testing:
┌─────────────────────────────────────────┐
│ Fargate Spot (70% discount)             │
│ - 1 task × 0.25 vCPU × $0.011 per hour  │
│ - 1 task × 0.5 GB × $0.0012 per GB/hr   │
│ ≈ $0.003/hour = $2.16/month             │
└─────────────────────────────────────────┘

Production:
┌─────────────────────────────────────────┐
│ Fargate Standard                        │
│ - 2 tasks × 0.25 vCPU × $0.04048 /hr    │
│ - 2 tasks × 0.5 GB × $0.004445 /GB/hr   │
│ ≈ $0.025/hour = $18/month               │
└─────────────────────────────────────────┘
```
